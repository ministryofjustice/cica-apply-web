"use strict";

require("core-js/modules/es.regexp.flags.js");
require("core-js/modules/esnext.array.filter-out.js");
require("core-js/modules/esnext.array.is-template-object.js");
require("core-js/modules/esnext.array.last-index.js");
require("core-js/modules/esnext.array.last-item.js");
require("core-js/modules/esnext.array.unique-by.js");
require("core-js/modules/esnext.async-iterator.constructor.js");
require("core-js/modules/esnext.async-iterator.as-indexed-pairs.js");
require("core-js/modules/esnext.async-iterator.drop.js");
require("core-js/modules/esnext.async-iterator.every.js");
require("core-js/modules/esnext.async-iterator.filter.js");
require("core-js/modules/esnext.async-iterator.find.js");
require("core-js/modules/esnext.async-iterator.flat-map.js");
require("core-js/modules/esnext.async-iterator.for-each.js");
require("core-js/modules/esnext.async-iterator.from.js");
require("core-js/modules/esnext.async-iterator.map.js");
require("core-js/modules/esnext.async-iterator.reduce.js");
require("core-js/modules/esnext.async-iterator.some.js");
require("core-js/modules/esnext.async-iterator.take.js");
require("core-js/modules/esnext.async-iterator.to-array.js");
require("core-js/modules/esnext.bigint.range.js");
require("core-js/modules/esnext.composite-key.js");
require("core-js/modules/esnext.composite-symbol.js");
require("core-js/modules/esnext.iterator.constructor.js");
require("core-js/modules/esnext.iterator.as-indexed-pairs.js");
require("core-js/modules/esnext.iterator.drop.js");
require("core-js/modules/esnext.iterator.every.js");
require("core-js/modules/esnext.iterator.filter.js");
require("core-js/modules/esnext.iterator.find.js");
require("core-js/modules/esnext.iterator.flat-map.js");
require("core-js/modules/esnext.iterator.for-each.js");
require("core-js/modules/esnext.iterator.from.js");
require("core-js/modules/esnext.iterator.map.js");
require("core-js/modules/esnext.iterator.reduce.js");
require("core-js/modules/esnext.iterator.some.js");
require("core-js/modules/esnext.iterator.take.js");
require("core-js/modules/esnext.iterator.to-array.js");
require("core-js/modules/esnext.map.delete-all.js");
require("core-js/modules/esnext.map.emplace.js");
require("core-js/modules/esnext.map.every.js");
require("core-js/modules/esnext.map.filter.js");
require("core-js/modules/esnext.map.find.js");
require("core-js/modules/esnext.map.find-key.js");
require("core-js/modules/esnext.map.from.js");
require("core-js/modules/esnext.map.group-by.js");
require("core-js/modules/esnext.map.includes.js");
require("core-js/modules/esnext.map.key-by.js");
require("core-js/modules/esnext.map.key-of.js");
require("core-js/modules/esnext.map.map-keys.js");
require("core-js/modules/esnext.map.map-values.js");
require("core-js/modules/esnext.map.merge.js");
require("core-js/modules/esnext.map.of.js");
require("core-js/modules/esnext.map.reduce.js");
require("core-js/modules/esnext.map.some.js");
require("core-js/modules/esnext.map.update.js");
require("core-js/modules/esnext.map.update-or-insert.js");
require("core-js/modules/esnext.map.upsert.js");
require("core-js/modules/esnext.math.clamp.js");
require("core-js/modules/esnext.math.deg-per-rad.js");
require("core-js/modules/esnext.math.degrees.js");
require("core-js/modules/esnext.math.fscale.js");
require("core-js/modules/esnext.math.iaddh.js");
require("core-js/modules/esnext.math.imulh.js");
require("core-js/modules/esnext.math.isubh.js");
require("core-js/modules/esnext.math.rad-per-deg.js");
require("core-js/modules/esnext.math.radians.js");
require("core-js/modules/esnext.math.scale.js");
require("core-js/modules/esnext.math.seeded-prng.js");
require("core-js/modules/esnext.math.signbit.js");
require("core-js/modules/esnext.math.umulh.js");
require("core-js/modules/esnext.number.from-string.js");
require("core-js/modules/esnext.number.range.js");
require("core-js/modules/esnext.object.iterate-entries.js");
require("core-js/modules/esnext.object.iterate-keys.js");
require("core-js/modules/esnext.object.iterate-values.js");
require("core-js/modules/esnext.observable.js");
require("core-js/modules/esnext.promise.try.js");
require("core-js/modules/esnext.reflect.define-metadata.js");
require("core-js/modules/esnext.reflect.delete-metadata.js");
require("core-js/modules/esnext.reflect.get-metadata.js");
require("core-js/modules/esnext.reflect.get-metadata-keys.js");
require("core-js/modules/esnext.reflect.get-own-metadata.js");
require("core-js/modules/esnext.reflect.get-own-metadata-keys.js");
require("core-js/modules/esnext.reflect.has-metadata.js");
require("core-js/modules/esnext.reflect.has-own-metadata.js");
require("core-js/modules/esnext.reflect.metadata.js");
require("core-js/modules/esnext.set.add-all.js");
require("core-js/modules/esnext.set.delete-all.js");
require("core-js/modules/esnext.set.difference.js");
require("core-js/modules/esnext.set.every.js");
require("core-js/modules/esnext.set.filter.js");
require("core-js/modules/esnext.set.find.js");
require("core-js/modules/esnext.set.from.js");
require("core-js/modules/esnext.set.intersection.js");
require("core-js/modules/esnext.set.is-disjoint-from.js");
require("core-js/modules/esnext.set.is-subset-of.js");
require("core-js/modules/esnext.set.is-superset-of.js");
require("core-js/modules/esnext.set.join.js");
require("core-js/modules/esnext.set.map.js");
require("core-js/modules/esnext.set.of.js");
require("core-js/modules/esnext.set.reduce.js");
require("core-js/modules/esnext.set.some.js");
require("core-js/modules/esnext.set.symmetric-difference.js");
require("core-js/modules/esnext.set.union.js");
require("core-js/modules/esnext.string.at.js");
require("core-js/modules/esnext.string.code-points.js");
require("core-js/modules/esnext.symbol.async-dispose.js");
require("core-js/modules/esnext.symbol.dispose.js");
require("core-js/modules/esnext.symbol.observable.js");
require("core-js/modules/esnext.symbol.pattern-match.js");
require("core-js/modules/esnext.symbol.replace-all.js");
require("core-js/modules/esnext.typed-array.filter-out.js");
require("core-js/modules/esnext.weak-map.delete-all.js");
require("core-js/modules/esnext.weak-map.from.js");
require("core-js/modules/esnext.weak-map.of.js");
require("core-js/modules/esnext.weak-map.emplace.js");
require("core-js/modules/esnext.weak-map.upsert.js");
require("core-js/modules/esnext.weak-set.add-all.js");
require("core-js/modules/esnext.weak-set.delete-all.js");
require("core-js/modules/esnext.weak-set.from.js");
require("core-js/modules/esnext.weak-set.of.js");
require("core-js/modules/web.immediate.js");
var axios = _interopRequireWildcard(require("axios"));
var jsCookies = _interopRequireWildcard(require("js-cookie"));
var _frontend = require("@ministryofjustice/frontend");
var _ga = _interopRequireDefault(require("../modules/ga"));
var _autocomplete = _interopRequireDefault(require("../modules/autocomplete/autocomplete"));
var _cookieBanner = _interopRequireDefault(require("../modules/cookie-banner"));
var _cookiePreference = _interopRequireDefault(require("../modules/cookie-preference"));
var _modalTimeout = _interopRequireDefault(require("../modules/modal-timeout"));
var _newWindowAnchors = _interopRequireDefault(require("../modules/new-window-anchors"));
var _liveChat = _interopRequireDefault(require("../modules/live-chat"));
var _postcodeLookup = _interopRequireDefault(require("../modules/postcode-lookup"));
var _govukOneLoginServiceHeader = _interopRequireDefault(require("../modules/govuk-one-login-service-header"));
var _msToMinutesAndSeconds = _interopRequireDefault(require("../modules/modal-timeout/utils/msToMinutesAndSeconds"));
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }
function _getRequireWildcardCache(e) { if ("function" != typeof WeakMap) return null; var r = new WeakMap(), t = new WeakMap(); return (_getRequireWildcardCache = function (e) { return e ? t : r; })(e); }
function _interopRequireWildcard(e, r) { if (!r && e && e.__esModule) return e; if (null === e || "object" != typeof e && "function" != typeof e) return { default: e }; var t = _getRequireWildcardCache(r); if (t && t.has(e)) return t.get(e); var n = { __proto__: null }, a = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var u in e) if ("default" !== u && Object.prototype.hasOwnProperty.call(e, u)) { var i = a ? Object.getOwnPropertyDescriptor(e, u) : null; i && (i.get || i.set) ? Object.defineProperty(n, u, i) : n[u] = e[u]; } return n.default = e, t && t.set(e, n), n; }
// eslint-disable-next-line import/no-extraneous-dependencies

// eslint-disable-next-line import/no-extraneous-dependencies

// eslint-disable-next-line import/no-extraneous-dependencies

(() => {
  const autocomplete = (0, _autocomplete.default)(window);
  autocomplete.init('.govuk-select');
  const postcodeLookup = (0, _postcodeLookup.default)(window);
  postcodeLookup.init();
  const cookiePreference = (0, _cookiePreference.default)('_prefs', ['essential', 'analytics']);
  if (cookiePreference.get('analytics').value === '1') {
    const cicaGa = (0, _ga.default)(window);
    cicaGa.init();
  } else {
    window[`ga-disable-${window.CICA.ANALYTICS_TRACKING_ID}`] = true;
  }
  const cookieBanner = (0, _cookieBanner.default)(window, cookiePreference, {
    cookieBannerElement: '#cookie-banner',
    cookieBannerVisibleClass: 'cookie-banner--visible',
    cookieBannerButtonAcceptAll: '#cookie-banner-accept-all'
  });
  cookieBanner.show();
  (0, _govukOneLoginServiceHeader.default)(window);

  /* ****************************************** */
  /* ** MODAL + TIMEOUT IMPLEMENTATION START ** */
  /* ****************************************** */

  async function modalTimout() {
    const modalElements = window.document.querySelectorAll('[data-module~="govuk-modal"]');
    let sessionEndedModal;
    let errorModal;
    let sessionTimingOutModal;
    const eventHandlers = {};
    let documentVisible = true;
    let sessionData;
    function getSessionData() {
      return JSON.parse(jsCookies.get('sessionExpiry') || '{}');
    }
    async function refreshSessionAndModalTimeout() {
      const response = await axios.get('/session/keep-alive');
      sessionData = response.data.data[0].attributes;
      sessionTimingOutModal.close();
      sessionTimingOutModal.refresh({
        startTime: sessionData.created
      });
    }
    function checkShouldOpenModal() {
      if (!sessionTimingOutModal.isOpen && documentVisible &&
      // session hasn't already ended. Avoids the modal opening
      // when a user blurs and focuses a tab after the session
      // has ended.
      Date.now() < sessionData.expires &&
      // session is nearing its end.
      sessionTimingOutModal.timer.timeRemaining < sessionData.duration / 6) {
        sessionTimingOutModal.open();
      }
    }
    if (modalElements.length) {
      sessionData = getSessionData();
      const sessionAlive = sessionData && sessionData.alive;

      // haven't hit `/apply` yet, or the application is completed
      // there is no session expiry cookie
      if (!sessionAlive || sessionAlive === 'timed-out') {
        return;
      }
      window.document.addEventListener('visibilitychange', () => {
        documentVisible = window.document.visibilityState === 'visible';
        if (documentVisible) {
          sessionData = getSessionData();
          checkShouldOpenModal();
        }
      });
      const TimeoutModal = (0, _modalTimeout.default)(window);
      sessionEndedModal = new TimeoutModal({
        element: '#govuk-modal-session-ended',
        closeElement: '.govuk-modal__close',
        onOpen: () => {
          window.gtag('event', 'open', {
            event_category: 'govuk-modal-session-ended',
            non_interaction: true
          });
        }
      });
      errorModal = new TimeoutModal({
        element: '#govuk-modal-session-resume-error',
        closeElement: '.govuk-modal__close',
        onOpen: () => {
          window.gtag('event', 'open', {
            event_category: '#govuk-modal-session-resume-error',
            non_interaction: true
          });
        }
      });
      sessionTimingOutModal = new TimeoutModal({
        element: '#govuk-modal-session-timing-out',
        resumeElement: '.govuk-modal__continue',
        // openIn: Math.floor((sessionData.duration * (1 / 4)) / 1000) * 1000,
        onBeforeOpen: () => {
          // if a user opens a new tab with another instance of `/apply` the
          // session will have been refreshed. Because of this the timeout modal
          // will open prematurely due to it working from a previously-set session
          // update date. check if the timers end time is less than the actual
          // session end time and calibrate the timeout to open the modal
          // accordingly.
          sessionData = getSessionData();
          const expectedEndTime = sessionTimingOutModal.timer.endTime;
          const actualEndTime = sessionData.expires;
          if (expectedEndTime < actualEndTime) {
            const now = Date.now();
            sessionTimingOutModal.close();
            sessionTimingOutModal.refresh({
              startTime: now,
              duration: sessionData.expires - now
            });
            return false;
          }
          return true;
        },
        onOpen: () => {
          window.gtag('event', 'open', {
            event_category: 'govuk-modal-session-timing-out',
            non_interaction: true
          });
          if (!eventHandlers.onOpenResumeElement) {
            const resumeElement = sessionTimingOutModal.config.element.querySelector('.govuk-modal__continue');
            eventHandlers.onOpenResumeElement = {
              element: resumeElement,
              handler: e => {
                e.preventDefault();
                refreshSessionAndModalTimeout().catch(() => {
                  errorModal.open();
                });
              }
            };
          }
          eventHandlers.onOpenResumeElement.element.addEventListener('click', eventHandlers.onOpenResumeElement.handler);
        },
        onClose: () => {
          eventHandlers.onOpenResumeElement.element.removeEventListener('click', eventHandlers.onOpenResumeElement.handler);
        },
        timer: {
          duration: sessionData.duration,
          startTime: new Date(sessionData.created) * 1,
          interval: 700,
          onTick: timeRemaining => {
            if (!documentVisible) {
              return;
            }
            // https://developer.mozilla.org/en-US/docs/Web/Accessibility/ARIA/ARIA_Live_Regions
            // aria-live="assertive" is an attribute of the span that contains the time remaining.
            // Only update the DOM when the modal is actually visible. This will prevent screen
            // readers from announcing every single DOM update that happens in the "background".
            if (sessionTimingOutModal.isOpen) {
              sessionTimingOutModal.content(title => {
                const titleElement = title;
                const timeRemainingElement = titleElement.querySelector('.govuk-modal__time-remaining');
                timeRemainingElement.innerHTML = (0, _msToMinutesAndSeconds.default)(timeRemaining);
              });
            }
            checkShouldOpenModal();
          },
          onEnd: () => {
            sessionTimingOutModal.close();
            // create a new sessionExpiry cookie
            const cookieData = {
              alive: 'timed-out',
              created: Date.now(),
              duration: 0,
              expires: Date.now()
            };
            const cookieString = JSON.stringify(cookieData);
            // Set the cookie
            window.document.cookie = `${encodeURIComponent('sessionExpiry')}=${encodeURIComponent(cookieString)}; path=/`;
            sessionEndedModal.open();
          }
        }
      });
      const textAreaElements = window.document.querySelectorAll('.govuk-textarea');
      textAreaElements.forEach(element => {
        element.addEventListener('paste', () => {
          refreshSessionAndModalTimeout();
        }, false);
        element.addEventListener('input', () => {
          const now = new Date() * 1;
          // if there is less than half the session length left when a user
          // updates a textarea, then refresh the session.
          if (now > new Date(sessionData.expires) * 1 - sessionData.duration / 2) {
            refreshSessionAndModalTimeout();
          }
        }, false);
      });
    }
  }
  modalTimout();

  /* ****************************************** */
  /* ** MODAL + TIMEOUT IMPLEMENTATION END   ** */
  /* ****************************************** */

  (0, _newWindowAnchors.default)(window.document.querySelectorAll('[open-new-window]'));
  (0, _liveChat.default)(window.document.querySelector('#chat-iframe'));
  (0, _frontend.initAll)();
})();
